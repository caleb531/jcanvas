!function($){function e(e){return e=e.replace(/\s/gi,"")}function t(){u.layer+=1}function a(){u.canvas+=1}function r(){u.global+=1}function s(e){var s={};s[e]=t,s[e]=a,c.setEventHooks(s),$.jCanvas.eventHooks[e]=r}function n(e){strictEqual(u.layer,e,"Triggers layer event callbacks"),strictEqual(u.canvas,e,"Triggers canvas event hooks"),strictEqual(u.global,e,"Triggers global event hooks")}function o(){c=$('<canvas width="500" height="500"></canvas>')}function i(){u={layer:0,canvas:0,global:0},$.jCanvas.clearCache(),$.jCanvas.eventHooks={}}var l=$("#qunit-fixture"),c,u;i(),module("Core API",{setup:o,teardown:i}),test("$.support.canvas",function(){strictEqual($.support.canvas,!0,"Detects canvas support")}),test("saveCanvas()",function(){var e;c.saveCanvas(),e=$.data(c[0],"jCanvas"),strictEqual(e.savedTransforms.length,1,"Pushes transformation state to stack")}),test("restoreCanvas()",function(){var e;c.saveCanvas(),e=$.data(c[0],"jCanvas"),c.restoreCanvas(),strictEqual(e.savedTransforms.length,0,"Pops transformation state from stack")}),test("rotateCanvas()",function(){var e;c.rotateCanvas({rotate:180}),e=$.data(c[0],"jCanvas"),strictEqual(e.savedTransforms.length,1,"Pushes transformation state to stack"),strictEqual(e.transforms.rotate,Math.PI,"Updates rotate property")}),test("scaleCanvas()",function(){var e;c.scaleCanvas({scale:2}),e=$.data(c[0],"jCanvas"),strictEqual(e.savedTransforms.length,1,"Pushes transformation state to stack"),strictEqual(e.transforms.scaleX,2,"Updates scaleX property"),strictEqual(e.transforms.scaleY,2,"Updates scaleY property")}),test("translateCanvas()",function(){var e;c.translateCanvas({translate:2}),e=$.data(c[0],"jCanvas"),strictEqual(e.savedTransforms.length,1,"Pushes transformation state to stack"),strictEqual(e.transforms.translateX,2,"Updates translateX property"),strictEqual(e.transforms.translateY,2,"Updates translateY property")}),module("Layer API",{setup:o,teardown:i}),test("getLayers()",function(){var e;deepEqual($().getLayers(),[],"Returns array for empty collection"),deepEqual(l.getLayers(),[],"Returns array for non-canvas"),e=c.getLayers(),deepEqual(e,[],"Returns empty array for initial canvas"),strictEqual(c.getLayers(),e,"Returns a reference to the layers array")}),test("getLayer()",function(){var e,t;t={layer:!0},strictEqual($().getLayer("square"),void 0,"Returns undefined for empty collection"),strictEqual(l.getLayer("square"),void 0,"Returns undefined for non-canvas"),strictEqual(c.getLayer("square"),void 0,"Returns undefined for non-existent layer"),strictEqual(c.getLayer(t),t,"Returns the given object"),c.addLayer({type:"rectangle",name:"square"}),c.addLayer({type:"arc",name:"circle"}),e=c.getLayer(0),ok("object"==typeof e&&$.isArray(e)===!1,"Layer can be retrieved by positive index"),strictEqual(c.getLayer(-2),e,"Layer can be retrieved by negative index"),strictEqual(c.getLayer("square"),e,"Layer can be retrieved by name"),strictEqual(c.getLayer(/^square$/gi),e,"Layer can be retrieved by regex"),strictEqual(c.getLayer(e),e,"Layer can be retrieved by object")}),test("getLayerGroup()",function(){var e;strictEqual($().getLayerGroup("squares"),void 0,"Returns undefined for empty collection"),strictEqual(l.getLayerGroup("squares"),void 0,"Returns undefined for non-canvas"),strictEqual(c.getLayerGroup("squares"),void 0,"Returns undefined for non-existent group"),c.addLayer({type:"rectangle",name:"square",groups:["squares"]}),c.addLayer({type:"arc",name:"circle",groups:["ovals"]}),e=c.getLayerGroup("squares"),ok($.isArray(e),"Group can be retrieved by index"),strictEqual(c.getLayerGroup(/^squares$/gi),e,"Group can be retrieved by regex"),strictEqual(c.getLayerGroup(e),e,"Group can be retrieved by object"),strictEqual(e.length,1,"Group contains the proper number of layers"),strictEqual(e[0],c.getLayer("square"),"Group contains the proper layer")}),test("getLayerIndex()",function(){strictEqual($().getLayerIndex("foo"),-1,"Returns -1 for empty collection"),strictEqual(l.getLayerIndex("foo"),-1,"Returns -1 for non-canvases"),strictEqual(c.getLayerIndex("foo"),-1,"Returns -1 for non-existent layer"),c.addLayer({type:"rectangle",name:"square"}),c.addLayer({type:"arc",name:"circle"}),strictEqual(c.getLayerIndex("square"),0,"Returns index of first layer"),strictEqual(c.getLayerIndex("circle"),1,"Returns index of second layer")}),test("setLayer()",function(){var e,a,r;s("change"),c.addLayer({type:"rectangle",name:"square",fillStyle:"black",width:100,height:100,change:t}),c.addLayer({type:"arc",name:"circle",change:t}),e=c.getLayer("square"),a=["boxes"],r={},c.setLayer(e,{fillStyle:"green",opacity:.5,name:"box",groups:a,data:r,width:"+=10",height:"-=10",rotate:"30",translate:0,text:"4"}),strictEqual(e.fillStyle,"green","Sets fillStyle of layer"),strictEqual(e.opacity,.5,"Sets opacity of layer"),strictEqual(c.getLayer("box"),e,"Sets name of layer"),notStrictEqual(e.groups,a,"Clones arrays in property map"),notStrictEqual(e.data,r,"Clones objects in property map"),strictEqual(e.width,110,"Increments width by 10"),strictEqual(e.height,90,"Decrements width by 10"),strictEqual(e.rotate,30,"Coerces numeric strings to numbers"),strictEqual(e.translate,0,"Handles zero values correctly"),strictEqual(e.text,"4","Does not coerce text property"),c.setLayer(e,{text:""}),strictEqual(e.text,"","Does not coerce empty text property"),n(2)}),test("setLayers()",function(){var e,a;s("change"),c.addLayer({type:"rectangle",name:"square",fillStyle:"black",change:t}),c.addLayer({type:"arc",name:"circle",fillStyle:"red",change:t}),e=c.getLayer("square"),a=c.getLayer("circle"),c.setLayers({fillStyle:"green"}),strictEqual(e.fillStyle,"green","Sets fillStyle of first layer"),strictEqual(a.fillStyle,"green","Sets fillStyle of second layer"),n(2)}),test("setLayerGroup()",function(){var e,a,r;s("change"),c.addLayer({type:"rectangle",name:"square",change:t}),c.addLayer({type:"arc",name:"circle",groups:["ovals"],change:t}),c.addLayer({type:"ellipse",name:"oval",groups:["ovals"],change:t}),e=c.getLayer("square"),a=c.getLayer("circle"),r=c.getLayer("oval"),c.setLayerGroup("ovals",{fillStyle:"green"}),strictEqual(a.fillStyle,"green","Sets properties of first layer in group"),strictEqual(r.fillStyle,"green","Sets properties of second layer in group"),notStrictEqual(e.fillStyle,"green","Does not set properties of layer outside of group"),n(2)}),test("moveLayer()",function(){s("move"),c.addLayer({type:"rectangle",name:"square",move:t}),c.addLayer({type:"arc",name:"circle"}),c.addLayer({type:"ellipse",name:"oval"}),c.moveLayer("square",1),strictEqual(c.getLayerIndex("square"),1,"Layer can be moved to positive index"),c.moveLayer("square",-1),strictEqual(c.getLayerIndex("square"),1,"Layer can be moved to negative index"),n(2)}),test("removeLayer()",function(){s("remove"),c.addLayer({type:"rectangle",name:"square",remove:t}),c.addLayer({type:"arc",name:"circle"});var e=c.getLayer("square");c.removeLayer("square"),strictEqual(c.getLayers().length,1,void 0,"Removes layer from layers array"),strictEqual(c.getLayer("square"),void 0,"Layer is no longer retrievable"),strictEqual(e._layer,void 0),notStrictEqual(e._method,void 0),n(1)}),test("removeLayers()",function(){s("remove"),c.addLayer({type:"rectangle",name:"square",remove:t}),c.addLayer({type:"arc",name:"circle",remove:t}),c.removeLayers(),strictEqual(c.getLayers().length,0,"Removes all layers from layers array"),strictEqual(c.getLayer("square"),void 0,"First layer is no longer retrievable"),strictEqual(c.getLayer("circle"),void 0,"Second layer is no longer retrievable"),n(2)}),test("removeLayerGroup()",function(){s("remove"),c.addLayer({type:"rectangle",name:"square"}),c.addLayer({type:"arc",name:"circle",groups:["ovals"],remove:t}),c.addLayer({type:"ellipse",name:"oval",groups:["ovals"],remove:t}),c.removeLayerGroup("ovals"),strictEqual(c.getLayers().length,1,"Removes layer group from layers array"),strictEqual(c.getLayerGroup("ovals"),void 0,"Layer group is no longer retrievable"),n(2)}),test("addLayerToGroup()",function(){var e,t,a;c.addLayer({type:"rectangle",name:"square",groups:["quadrilaterals"]}),c.addLayer({type:"arc",name:"circle"}),c.addLayer({type:"ellipse",name:"oval",groups:[]}),c.addLayerToGroup("square","squares"),c.addLayerToGroup("circle","ovals"),c.addLayerToGroup("oval","ovals"),t=c.getLayerGroup("squares"),a=c.getLayerGroup("ovals"),strictEqual(t.length,1,"Adds layer to group if layer is associated with at least one group"),strictEqual(a.length,2,"Adds layer to group if layer is not associated with any groups"),c.removeLayers(),e=["ovals"],c.addLayer({type:"arc",name:"circle",groups:e}),c.addLayer({type:"ellipse",name:"oval",groups:e}),c.addLayerToGroup("oval","ellipses"),strictEqual(c.getLayerGroup("ellipses").length,1,"Groups array is cloned upon layer creation")}),test("removeLayerFromGroup()",function(){var e,t;c.addLayer({type:"rectangle",name:"square",groups:["shapes","squares"]}),c.removeLayerFromGroup("square","squares"),e=c.getLayerGroup("shapes"),t=c.getLayerGroup("squares"),strictEqual(t,void 0,"Removes layer from group"),strictEqual(e.length,1,"Layer remains in other groups")}),module("Event API",{setup:o,teardown:i}),test("getEventHooks()",function(){deepEqual($().getEventHooks(),{},"Returns object for empty collecion"),deepEqual(l.getEventHooks(),{},"Returns object for non-canvas"),deepEqual(c.getEventHooks(),{},"Returns object for canvas")}),test("setEventHooks()",function(){c.setEventHooks({add:$.noop}),strictEqual(c.getEventHooks().add,$.noop,"Sets event hooks for canvas")}),test("triggerLayerEvent()",function(){s("mousedown"),c.addLayer({type:"rectangle",name:"square",mousedown:t}),c.triggerLayerEvent("square","mousedown"),n(1)}),module("Animation API",{setup:o,teardown:i}),asyncTest("animateLayer()",function(){expect(8),c.addLayer({type:"path",opacity:1,fillStyle:"rgba(0, 0, 0)",strokeStyle:"#000",shadowColor:"rgba(0, 0, 0, 1)",strokeWidth:2,p1:{type:"line",x1:0,y1:0,x2:100,y2:100}}),c.animateLayer(0,{fillStyle:"#f00",strokeStyle:"rgb(255, 0, 0)",shadowColor:"rgba(255, 0, 0, 0.5)",strokeWidth:10,p1:{x1:50}},10,function(t){var a;strictEqual(e(t.fillStyle),"rgb(255,0,0)","Animates hexadecimal color"),strictEqual(e(t.strokeStyle),"rgb(255,0,0)","Animates RGB color"),strictEqual(e(t.shadowColor),"rgba(255,0,0,0.5)","Animates RGBA color"),strictEqual(t.strokeWidth,10,"Animates strokeWidth property"),strictEqual(t.p1.x1,50,"Sub-property is animated"),strictEqual(t["p1.x1"],void 0,"Sub-property alias is deleted"),a=!1,c.animateLayer(0,{opacity:.5},{duration:10,step:function(e,t){a||(strictEqual(t.prop,"opacity","Hidden properties do not begin with underscore when step callback is running"),a=!0)},complete:function(e){strictEqual(e,c.getLayer(0),"Layer object is passed to complete callback"),start()}})})}),module("Text API",{setup:o,teardown:i}),test("drawText()",function(){var e;c.drawText({layer:!0,name:"text1",fontFamily:"sans-serif",fontSize:36,text:"Hello"}),e=c.getLayer("text1"),ok(e.width,"Width is calculated"),ok(e.height,"Height is calculated"),ok(e.text,"Text is defined"),c.drawText({layer:!0,name:"text2",fontFamily:"sans-serif",fontSize:36,text:3}),e=c.getLayer("text2"),strictEqual(e.text,"3","Number value for text is cast to string"),c.drawText({layer:!0,name:"text3",fontFamily:"sans-serif",fontSize:36,text:"3"}),e=c.getLayer("text3"),strictEqual(e.text,"3","Numeric string value for text remains string"),c.drawText({layer:!0,name:"text4",fontFamily:"sans-serif",fontSize:36,text:"3.0"}),e=c.getLayer("text4"),strictEqual(e.text,"3.0","Decimal string value for text remains string"),c.drawText({layer:!0,name:"text5",fontFamily:"sans-serif",fontSize:"48pt",text:"hello"}),e=c.getLayer("text5"),strictEqual(e.fontSize,"48pt","Font sizes with units are not coerced to number literals"),c.drawText({layer:!0,name:"text6",fontFamily:"sans-serif",fontSize:36,text:" "}),e=c.getLayer("text6"),strictEqual(e.text," ","Whitespace string value for text remains string")}),test("measureText()",function(){var e,t;e={layer:!0,type:"text",fontFamily:"sans-serif",fontSize:36,text:"Hello"},t=c.measureText({fontFamily:"sans-serif",fontSize:36,text:"Hello"}),strictEqual(typeof t.width,"number","Width is calculated for the given object"),strictEqual(typeof t.height,"number","Height is calculated for the given object"),c.addLayer(e),t=c.measureText(0),strictEqual(typeof t.width,"number","Width is calculated for the given layer"),strictEqual(typeof t.height,"number","Height is calculated for the given layer")}),module("Image API",{setup:o,teardown:i}),asyncTest("drawImage()",function(){expect(4);var e=0;c.drawImage({layer:!0,name:"fish",source:"images/fish.jpg",load:function(t){e+=1,1===e?(strictEqual(c.getLayer("fish"),t,"Layer is passed to callback initially"),strictEqual(t.width,220,"Width is calculated"),strictEqual(t.height,138,"Height is calculated")):2===e&&(strictEqual(c.getLayer("fish"),t,"Layer is passed to callback on redraw"),start())}}),c.drawLayers()}),test("getCanvasImage()",function(){var e,t;e=l.getCanvasImage(),strictEqual(e,null,"Returns null for non-canvas elements"),e=c.getCanvasImage(),strictEqual(e.indexOf("data:image/png;base64,"),0,"Returns data URL of type image/png by default"),e=c.getCanvasImage("png"),strictEqual(e.indexOf("png"),11,"Returns data URL of type image/png"),e=c.getCanvasImage("jpeg"),strictEqual(e.indexOf("jpeg"),11,"Returns data URL of type image/jpeg"),t=c.getCanvasImage("jpeg",.5),notStrictEqual(e,t,"Returns data URL of type image/jpeg with 50% compression")})}(jQuery);